---
title: "Protein and RNA pvalues for apaQTLs"
author: "Briana Mittleman"
date: "2/19/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(workflowr)
library(reshape2)
library(tidyverse)
library(qvalue)
```

For a lot of this project I have been looking at the relationship between APA, RNA, and protein. I want to use trhis analysis to get the nominal pvalues for the associations of the snp:gene pairs found in the APA qtl analysis. This will help me find examples and look at the distributions overall. 

I want a file that has the nominal pvalues for each of the apaQTls in the total 3', nuclear 3', RNA, and protein. I will have to convert the gene names. 

Start with a dictionary of the QTLs. It will have the snp as the key and converted gene as the value. I can then write out the associations.

I can do this seperate for RNA and protein with total and nuclear by having a script that can take all of the combinations. After I get the results I can merge them and add NAs for missing measurements.  


I can ask questions like, given a snp is a apaQTL what is nom association in other pheno.  

Molpval4ApaQTL.py
```{bash,eval=F}


def main(QTL, phen, outF, phenotype):  
    fout=open(outF,"w")
    geneNames=open("/project2/gilad/briana/genome_anotation_data/ensemble_to_genename.txt","r")
    #gene name dictionary  
    geneDic={}
    geneDicOpp={}
    for i, ln in enumerate(geneNames):
        if i >0:
            ID=ln.split()[0]
            gene=ln.split()[1]
            if gene not in geneDic.keys():
                geneDic[gene]=[ID]
            else: 
                geneDic[gene].append(ID)
            geneDicOpp[ID]=gene
    print(geneDicOpp.keys())
    #qtl dic
    qtlDic={}
    for ln in open(QTL,"r"):
        snp=ln.split()[5]
        gene=ln.split()[0].split(":")[-1].split("_")[0]
        #gene_id=geneDic[gene]
        qtlDic[snp]=gene
    #loop over pheno
    for ln in open(phen,"r"):
        snp=ln.split()[1]
        if snp in qtlDic.keys():
            if phenotype == "RNA":
                gene=ln.split()[0].split(".")[0]
                if gene not in geneDicOpp.keys():
                    next
                geneName=geneDicOpp[gene]
            else:
                gene=ln.split()[0]
                if gene not in geneDicOpp.keys():
                    next
                geneName=geneDicOpp[gene]
            if qtlDic[snp]==geneName:
               pval=ln.split()[3]
               fout.write("%s\t%s\t%s\t%s\n"%(snp, gene, geneName, pval))
    fout.close()





    
if __name__ == "__main__":
    import sys
    fraction = sys.argv[1]
    pheno = sys.argv[2]
    inQTL="/project2/gilad/briana/threeprimeseq/data/ApaQTLs/%sapaQTLs.GeneLocAnno.noMP.5perc.10FDR.txt"%(fraction)
    if pheno == "RNA":
        inPhen="/project2/gilad/briana/threeprimeseq/data/molecular_QTLs/nom/fastqtl_qqnorm_RNAseq_phase2.fixed.nominal.out"
    if pheno =="Protein":  
        inPhen= "/project2/gilad/briana/threeprimeseq/data/molecular_QTLs/nom/fastqtl_qqnorm_prot_fixed.nominal.out"
    out="/project2/gilad/briana/threeprimeseq/data/ApaQTLs_otherPhen/%sQTLsin%s.txt"%(fraction, pheno)
    main(inQTL, inPhen, out, pheno)
    
```


Run this on all combinations:  

run_Molpval4ApaQTL.sh
```{bash,eval=F}
#!/bin/bash

#SBATCH --job-name=run_Molpval4ApaQTL
#SBATCH --account=pi-yangili1
#SBATCH --time=36:00:00
#SBATCH --output=run_Molpval4ApaQTL.out
#SBATCH --error=run_Molpval4ApaQTL.err
#SBATCH --partition=broadwl
#SBATCH --mem=30G
#SBATCH --mail-type=END


module load Anaconda3
source activate three-prime-env

python Molpval4ApaQTL.py Total RNA
python Molpval4ApaQTL.py Nuclear RNA
python Molpval4ApaQTL.py Total Protein
python Molpval4ApaQTL.py Nuclear Protein

```


Pull these in: 

```{r}
NucRNA=read.table("../data/ApaQTLs_otherPhen/NuclearQTLsinRNA.txt", col.names = c("SNP", "Gene", "GeneName", "RNA_P"),stringsAsFactors = F)
TotRNA=read.table("../data/ApaQTLs_otherPhen/TotalQTLsinRNA.txt", col.names = c("SNP", "Gene", "GeneName", "RNA_P"),stringsAsFactors = F)
NucProt=read.table("../data/ApaQTLs_otherPhen/NuclearQTLsinProtein.txt", col.names = c("SNP", "Gene", "GeneName", "Prot_P"),stringsAsFactors = F)
TotProt=read.table("../data/ApaQTLs_otherPhen/TotalQTLsinProtein.txt", col.names = c("SNP", "Gene", "GeneName", "Prot_P"),stringsAsFactors = F)
```



Pi1 values: 

Nuclear: 

* RNA
```{r}
NucRNAPi=pi0est(NucRNA$RNA_P, pi0.method = "bootstrap")
1-NucRNAPi$pi0
```
* Protein  
```{r}
NucProtPi=pi0est(NucProt$Prot_P, pi0.method = "bootstrap")
1-NucProtPi$pi0
```

Total:  

* RNA 
```{r}
TotRNAPi=pi0est(TotRNA$RNA_P, pi0.method = "bootstrap")
1-TotRNAPi$pi0

```
* Protein   
```{r}
TotProtPi=pi0est(TotProt$Prot_P, pi0.method = "bootstrap")
1-TotProtPi$pi0
```

Histograms:  

```{r}
png("../output/plots/OverlapRNAandProtPi.png")
par(mfrow=c(2,2))
hist(TotRNA$RNA_P,xlab="RNA Pvalue", main="Total apaQTLs \nin RNA")  
text(.6,50, paste("pi_1=", round((1-TotRNAPi$pi0), digit=3), sep=" "))
hist(TotProt$Prot_P,xlab="Protein Pvalue", main="Total apaQTLs \nin Protein")
text(.6,20, paste("pi_1=", round((1-TotProtPi$pi0), digit=3), sep=" "))
hist(NucRNA$RNA_P,xlab="RNA Pvalue", main="Nuclear apaQTLs \nin RNA")  
text(.6,90, paste("pi_1=", round((1-NucRNAPi$pi0), digit=3), sep=" "))
hist(NucProt$Prot_P,xlab="Protein Pvalue", main="Nuclear apaQTLs \nin Protein")
text(.6,30, paste("pi_1=", round((1-NucProtPi$pi0), digit=3), sep=" "))
dev.off()
```


Put together to look at examples and distributions:  

```{r}
NucOverlap=NucRNA %>% full_join(NucProt, by=c("SNP", "Gene", "GeneName"))

NucOverlap_melt=melt(NucOverlap, id.vars = c("SNP", "Gene", "GeneName"))
colnames(NucOverlap_melt)=c("SNP", "Gene", "GeneName", "Pheno", "Pvalue")

ggplot(NucOverlap_melt, aes(x=Pvalue, by=Pheno, fill=Pheno))+ geom_density(alpha=.5) +labs(title="RNA and Protien Pvalues for Nuclear apaQTLs") + scale_fill_manual(values=c("yellow","blue"))

```


```{r}
TotOverlap=TotRNA %>% full_join(TotProt, by=c("SNP", "Gene", "GeneName"))

TotOverlap_melt=melt(TotOverlap, id.vars = c("SNP", "Gene", "GeneName"))
colnames(TotOverlap_melt)=c("SNP", "Gene", "GeneName", "Pheno", "Pvalue")

ggplot(TotOverlap_melt, aes(x=Pvalue, by=Pheno, fill=Pheno))+ geom_density(alpha=.5) + labs(title="RNA and Protien Pvalues for Total apaQTLs") + scale_fill_manual(values=c("yellow","blue"))
```

